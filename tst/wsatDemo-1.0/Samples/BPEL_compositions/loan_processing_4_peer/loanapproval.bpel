<process name="loanapproval" 
         targetNamespace="http://acme.com/loanprocessing"
         suppressJoinFailure="yes"
         xmlns="http://schemas.xmlsoap.org/ws/2003/03/business-process/"
         xmlns:lns="http://loans.org/wsdl/loan-approval"
         xmlns:loandef="http://tempuri.org/services/loandefinitions" 
         xmlns:asns="http://tempuri.org/services/loanassessor"
         xmlns:apns="http://tempuri.org/services/loanapprover">

  <variables>
    <variable name="request" 
               messageType="loandef:creditInformationMessage"/>
    <variable name="riskAssessment" 
               messageType="asns:riskAssessmentMessage"/>
    <variable name="approvalInfo" 
               messageType="apns:approvalMessage"/>
    <variable name="error" 
               messageType="loandef:loanRequestErrorMessage"/>
  </variables>

  <partners>
    <partner name="customer" 
             serviceLinkType="lns:loanApprovalLinkType"
             myRole="approver"/>
    <partner name="approver" 
             serviceLinkType="lns:loanApprovalLinkType"
             partnerRole="approver"/>
    <partner name="assessor" 
             serviceLinkType="lns:riskAssessmentLinkType"
             partnerRole="assessor"/>
  </partners>

  <faultHandlers>
    <catch faultName="lns:loanProcessFault" 
           faultVariable="error">
      <reply partner="customer"
             portType="apns:loanApprovalPT" 
             operation="approve"
             variable="error" 
             faultName="loanProcessFault"/>
    </catch>
  </faultHandlers>

  <flow>
    <links>
      <link name="receive-to-assess"/>
      <link name="receive-to-approval"/>
      <link name="approval-to-reply"/>
      <link name="assess-to-setMessage"/>
      <link name="setMessage-to-reply"/>
      <link name="assess-to-approval"/>
     
    </links>

    <receive name="receive1" partner="customer" 
             portType="apns:loanApprovalPT" 
             operation="approve" variable="request"
             createInstance="yes">
      <source linkName="receive-to-assess"
              transitionCondition="bpws:getVariableData('request', 'amount')&lt;4"/>
      <source linkName="receive-to-approval"
              transitionCondition="bpws:getVariableData('request', 'amount')&gt;=4"/>
    </receive>

    <invoke name="invokeAssessor" partner="assessor" 
            portType="asns:riskAssessmentPT" 
            operation="check"
            inputVariable="request"  
            outputVariable="riskAssessment">
      <target linkName="receive-to-assess"/>
      <source linkName="assess-to-setMessage" 
              transitionCondition="bpws:getVariableData('riskAssessment', 'risk')='low'"/>
      <source linkName="assess-to-approval" 
              transitionCondition="bpws:getVariableData('riskAssessment', 'risk')!='low'"/>
    </invoke>

    <assign name="assign">
      <target linkName="assess-to-setMessage"/>
      <source linkName="setMessage-to-reply"/>
      <copy>
        <from expression="'yes'"/>
        <to variable="approvalInfo" part="accept"/>
      </copy>
    </assign>

    <invoke name="invokeapprover" 
            partner="approver" portType="apns:loanApprovalPT" 
            operation="approve" 
            inputVariable="request" 
            outputVariable="approvalInfo">
      <target linkName="receive-to-approval"/>
      <target linkName="assess-to-approval"/>
      <source linkName="approval-to-reply" />
    </invoke>

    <reply name="reply" partner="customer" portType="apns:loanApprovalPT" 
           operation="approve" variable="approvalInfo">
      <target linkName="setMessage-to-reply"/>
      <target linkName="approval-to-reply"/>
    </reply>
  </flow>
</process>
